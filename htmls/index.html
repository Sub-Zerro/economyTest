<!DOCTYPE HTML>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>Вопросы</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400&display=swap" rel="stylesheet">

  <style>
*{
  background-color:#45075c;
}
body {
  justify-content: center;
  text-align: center;
  align-items: center;
  width: 100%;
  height: 100%;
}
.textarea {
  color: white;
  margin-top: 50px;
  font-size: 80px;
  font-family: "Comfortaa";
  margin-bottom: 50px;

}

.but {

  justify-content: center;
  height: 300px;
  width: 60%;
  margin-left: auto;
  margin-right: 0;
  margin-top: 10px;
  border-radius: 100px;
  font-size: 50px;
  color: white;
  font-family: "Comfortaa";
  margin-top: 50px;
  box-shadow: 20px 20px black;
}
#b1 {
  background-color: #4762e5;
}
#b2 {
  background-color: #299dcf;
}
#b3{
 background-color: #edcb51;
}
#b4{
  background-color: #e57747;
}
  </style>

</head>
  <body>

  <div class="textarea"></div>
  <button class="but" id="b1"></button><br>
  <button class="but" id="b2"></button><br>
  <button class="but" id="b3"></button><br>
  <button class="but" id="b4"></button><br>

  <script>



    let scope_str = '';
    let number_of_q = 0;
    let name;
    let num_quiz_for_save;

    let skip = false;

    let my_obj;

    get_num_quiz(number_of_q);

    getName();

    function showQ(numQ, obj, num_quiz_f){

      console.log("scopestr = ", scope_str);

      let arr = obj.arr;

      // for(let i = 0; i < arr.length; i++){
      //   console.log(arr[i]);
      // }


      let textarea = document.querySelector('.textarea');
      let buttons = document.querySelectorAll('button');


      textarea.textContent = arr[numQ][0];

      for (let i = 0; i < buttons.length; i++){
        buttons[i].style.display = 'inline';
      }

      if (arr[numQ][1] != ''){
        buttons[0].textContent = arr[numQ][1];
      }else{
        buttons[0].style.display = 'none'
      }
      if (arr[numQ][2] != ''){
        buttons[1].textContent = arr[numQ][2];
      }else{
        buttons[1].style.display = 'none'
      }

      if (arr[numQ][3] != ''){
        buttons[2].textContent = arr[numQ][3];
      }else{
        buttons[2].style.display = 'none'
      }

      if (arr[numQ][4] != ''){
        buttons[3].textContent = arr[numQ][4];
      }else{
        buttons[3].style.display = 'none'
      }


      for(let i = 0; i < buttons.length; i++){
        buttons[i].onclick = (()=>{
          scope_str+=`${i+1}`;
          if (scope_str.length==(number_of_q+1)){
            if (number_of_q < (arr.length-1)){
              number_of_q++;
              showQ(number_of_q, obj, num_quiz_f);
            }else{

              (async ()=>{

                await fetch("/", {
                  method: "post",
                  headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    name: name,
                    answer: scope_str,
                    num_quiz: num_quiz_f
                  })
                }).then((res)=>{
                  res.json().then(async (res_end)=>{
                    await alert("Ответ записан, вкладку можно закрывать");
                    window.location.replace('/');
                  })
                })


              })()






            }
          }
        })

      }


    }

    function getName(){
      name = prompt('Введите имя и фамилию');
      if (name == undefined || name == '' || name == null){
        getName();
      }else{
        return name;
      }
      alert('Тест без таймера, все задания оцениваются одинаково. Задача - нажать на вариант ответа, который считаешь правильным')
    }

    function get_num_quiz(numQ){
      let num = prompt("Ведите номер квиза");
      if (num=='' || num==null || num==undefined){
        get_num_quiz(numQ);
      }else{

        let f = fetch("/do", {
          method: "post",
          headers:{
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            num: Number(num)
          })
        }).then((res)=>{
          res.json().then((res_end)=>{
            if (res_end.islock == true){
              (async ()=>{
                await alert("В данный момент квиз закрыт");
                window.location.replace("/");
              })()
            }else{
              my_obj = res_end;
              num_quiz_for_save = res_end.num_quiz;
              showQ(numQ, res_end, res_end.num_quiz);
            }
          }).catch(()=>{
            (async ()=>{
              await alert('Квиз не найден');
              window.location.replace("/");
            })()

          })
        }).catch(()=>{
          window.location.replace("/");
        })
      return

      }
    }

    document.addEventListener("visibilitychange", async function(){
      if (document.hidden){
        scope_str+='0';

        number_of_q++;

        await alert("Вы открыли другую вкладку, текущий вопрос аннулируется");

        showQ(number_of_q, my_obj, num_quiz_for_save);
      }
    });

  </script>
</body>
</html>
